# Generated by Claude.
openapi: 3.1.0
info:
  title: Alexandria API
  description: API for managing libraries and books
  version: 1.0.0
  contact:
    name: Alexandria

servers:
  - url: /v1
    description: API v1

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: AWS Cognito JWT token

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
      required:
        - message

    # Detection
    DetectRequest:
      type: object
      properties:
        type:
          type: integer
          description: "Item type (0 = Book, 1 = Video)"
          enum: [0, 1]
        code:
          type: string
          description: "ISBN code (10 or 13 digits) - required for books"
        image:
          type: string
          description: "Base64 encoded image for video OCR detection"
        title:
          type: string
          description: "Manual title for video search"
      required:
        - type

    DetectedBookResponse:
      type: object
      properties:
        id:
          type: string
        authors:
          type: array
          items:
            type: string
        title:
          type: string
        summary:
          type: string
        pictureUrl:
          type: string
          nullable: true
        isbn:
          type: string
        source:
          type: string
        error:
          type: string
          nullable: true

    DetectedVideoResponse:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        summary:
          type: string
        pictureUrl:
          type: string
          nullable: true
        directors:
          type: array
          items:
            type: string
        cast:
          type: array
          items:
            type: string
        releaseYear:
          type: integer
        duration:
          type: integer
          description: "Duration in minutes"
        tmdbId:
          type: string
        source:
          type: string
        error:
          type: string
          nullable: true

    DetectResponse:
      type: object
      properties:
        detectedBooks:
          type: array
          items:
            $ref: "#/components/schemas/DetectedBookResponse"
        detectedVideos:
          type: array
          items:
            $ref: "#/components/schemas/DetectedVideoResponse"
        extractedTitle:
          type: string
          nullable: true
          description: "Title extracted via OCR from image"

    # Library
    CreateLibraryRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 20
          description: "Library name (required, max 20 chars)"
        description:
          type: string
          maxLength: 100
          description: "Library description (max 100 chars)"
      required:
        - name

    CreateLibraryResponse:
      type: object
      properties:
        id:
          type: string
        totalItems:
          type: integer
        updatedAt:
          type: string
          format: date-time
          nullable: true

    UpdateLibraryRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 20
        description:
          type: string
          maxLength: 100
      required:
        - name

    GetLibraryResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        totalItems:
          type: integer
        updatedAt:
          type: string
          format: date-time
          nullable: true
        sharedTo:
          type: array
          items:
            type: string
          description: "List of usernames the library is shared with"
        sharedFrom:
          type: string
          nullable: true
          description: "Username of the owner if this is a shared library"

    GetLibrariesResponse:
      type: object
      properties:
        libraries:
          type: array
          items:
            $ref: "#/components/schemas/GetLibraryResponse"

    ShareRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: "Email of the user to share with"
      required:
        - email

    UnshareRequest:
      type: object
      properties:
        emails:
          type: array
          items:
            type: string
            format: email
          minItems: 1
          maxItems: 10
          description: "List of user emails to remove sharing from"
      required:
        - emails

    # Items
    ItemType:
      type: integer
      enum: [0, 1, 2]
      description: "Item type (0 = Book, 1 = Video, 2 = Collection)"

    GetItemResponseBase:
      type: object
      properties:
        id:
          type: string
        type:
          $ref: "#/components/schemas/ItemType"
        title:
          type: string
        picture:
          type: string
          nullable: true
          description: "Base64 encoded picture"
        pictureUrl:
          type: string
          nullable: true
        libraryId:
          type: string
          nullable: true
        libraryName:
          type: string
          nullable: true
        ownerId:
          type: string
        lentTo:
          type: string
          nullable: true
          description: "Name of person the item is lent to"
        collectionId:
          type: string
          nullable: true
          description: "Collection ID"
        collectionName:
          type: string
          nullable: true
          description: "Collection name (denormalized)"
        order:
          type: integer
          nullable: true
          description: "Order within collection (1-1000)"

    GetBookResponse:
      allOf:
        - $ref: "#/components/schemas/GetItemResponseBase"
        - type: object
          properties:
            authors:
              type: array
              items:
                type: string
            summary:
              type: string
            isbn:
              type: string

    GetVideoResponse:
      allOf:
        - $ref: "#/components/schemas/GetItemResponseBase"
        - type: object
          properties:
            directors:
              type: array
              items:
                type: string
            cast:
              type: array
              items:
                type: string
            releaseYear:
              type: integer
              nullable: true
            duration:
              type: integer
              nullable: true
              description: "Duration in minutes"
            tmdbId:
              type: string
              nullable: true

    GetCollectionItemResponse:
      allOf:
        - $ref: "#/components/schemas/GetItemResponseBase"
        - type: object
          description: "Collection item (type=2) with nested items"
          properties:
            description:
              type: string
              nullable: true
            items:
              type: array
              description: "Nested items within this collection (books/videos)"
              items:
                oneOf:
                  - $ref: "#/components/schemas/GetBookResponse"
                  - $ref: "#/components/schemas/GetVideoResponse"
            itemCount:
              type: integer
              description: "Total items in collection (denormalized from DynamoDB)"
            partial:
              type: boolean
              description: "True if this collection continues from a previous page"

    GetLibrariesContentResponse:
      type: object
      properties:
        items:
          type: array
          description: "Mixed array of books, videos, and collections. Collections (type=2) have nested items."
          items:
            oneOf:
              - $ref: "#/components/schemas/GetBookResponse"
              - $ref: "#/components/schemas/GetVideoResponse"
              - $ref: "#/components/schemas/GetCollectionItemResponse"
        nextToken:
          type: string
          description: "Pagination token for next page"

    CreateBookRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 100
        summary:
          type: string
          maxLength: 4000
        authors:
          type: array
          items:
            type: string
        isbn:
          type: string
        pictureUrl:
          type: string
          nullable: true
        collectionId:
          type: string
          nullable: true
          description: "Collection ID to add the book to"
        order:
          type: integer
          nullable: true
          minimum: 1
          maximum: 1000
      required:
        - title

    CreateBookResponse:
      type: object
      properties:
        id:
          type: string
        updatedAt:
          type: string
          format: date-time
          nullable: true

    UpdateBookRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 100
        summary:
          type: string
          maxLength: 4000
        authors:
          type: array
          items:
            type: string
        isbn:
          type: string
        pictureUrl:
          type: string
          nullable: true
        collectionId:
          type: string
          nullable: true
          description: "Collection ID (null to remove from collection)"
        order:
          type: integer
          nullable: true
          minimum: 1
          maximum: 1000
        updatePicture:
          type: boolean
          nullable: true
          description: "If true, fetch and update the picture from pictureUrl"
      required:
        - title

    CreateVideoRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 100
        summary:
          type: string
          maxLength: 4000
        directors:
          type: array
          items:
            type: string
            maxLength: 100
        cast:
          type: array
          items:
            type: string
        releaseYear:
          type: integer
          nullable: true
          minimum: 1800
          maximum: 2100
        duration:
          type: integer
          nullable: true
          minimum: 0
          maximum: 1000
          description: "Duration in minutes"
        tmdbId:
          type: string
          nullable: true
        pictureUrl:
          type: string
          nullable: true
        collectionId:
          type: string
          nullable: true
          description: "Collection ID to add the video to"
        order:
          type: integer
          nullable: true
          minimum: 1
          maximum: 1000
      required:
        - title

    CreateVideoResponse:
      type: object
      properties:
        id:
          type: string
        updatedAt:
          type: string
          format: date-time
          nullable: true

    UpdateVideoRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 100
        summary:
          type: string
          maxLength: 4000
        directors:
          type: array
          items:
            type: string
            maxLength: 100
        cast:
          type: array
          items:
            type: string
        releaseYear:
          type: integer
          nullable: true
          minimum: 1800
          maximum: 2100
        duration:
          type: integer
          nullable: true
          minimum: 0
          maximum: 1000
          description: "Duration in minutes"
        tmdbId:
          type: string
          nullable: true
        pictureUrl:
          type: string
          nullable: true
        collectionId:
          type: string
          nullable: true
          description: "Collection ID (null to remove from collection)"
        order:
          type: integer
          nullable: true
          minimum: 1
          maximum: 1000
        updatePicture:
          type: boolean
          nullable: true
          description: "If true, fetch and update the picture from pictureUrl"
      required:
        - title

    # Item History
    ItemEventType:
      type: string
      enum:
        - LENT
        - RETURNED

    ItemHistoryEntryRequest:
      type: object
      properties:
        type:
          $ref: "#/components/schemas/ItemEventType"
        event:
          type: string
          maxLength: 50
          description: "Name of person (for lend/return)"
      required:
        - type
        - event

    ItemHistoryEntry:
      type: object
      properties:
        date:
          type: string
          format: date-time
          nullable: true
        type:
          $ref: "#/components/schemas/ItemEventType"
        event:
          type: string

    ItemHistoryEntryListResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/ItemHistoryEntry"
        nextToken:
          type: string
          description: "Pagination token for next page"

    # Search
    SearchRequest:
      type: object
      properties:
        terms:
          type: array
          items:
            type: string
          description: "Search terms for fuzzy search"
      required:
        - terms

    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/GetBookResponse"

    # Collections
    CreateCollectionRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
          description: "Collection name (required, unique per library)"
        description:
          type: string
          maxLength: 500
          description: "Collection description"
      required:
        - name

    CreateCollectionResponse:
      type: object
      properties:
        id:
          type: string

    UpdateCollectionRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 500
      required:
        - name

    GetCollectionResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        itemCount:
          type: integer

    GetCollectionsResponse:
      type: object
      properties:
        collections:
          type: array
          items:
            $ref: "#/components/schemas/GetCollectionResponse"

paths:
  /detections:
    post:
      summary: Detect item by code or image
      description: |
        Resolve item information from external sources.
        - For books (type=0): provide ISBN code
        - For videos (type=1): provide either base64 image (OCR) or manual title
      operationId: requestDetection
      tags:
        - Detection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DetectRequest"
      responses:
        "200":
          description: Successfully detected books
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DetectResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries:
    get:
      summary: List libraries
      description: Get all libraries owned by or shared with the current user
      operationId: listLibraries
      tags:
        - Libraries
      responses:
        "200":
          description: List of libraries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetLibrariesResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Create library
      description: Create a new library
      operationId: createLibrary
      tags:
        - Libraries
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLibraryRequest"
      responses:
        "201":
          description: Library created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateLibraryResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    put:
      summary: Update library
      description: Update library name and description
      operationId: updateLibrary
      tags:
        - Libraries
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateLibraryRequest"
      responses:
        "200":
          description: Library updated
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete library
      description: Delete a library and all its contents
      operationId: deleteLibrary
      tags:
        - Libraries
      responses:
        "200":
          description: Library deleted
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/items:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: List library items
      description: |
        Get paginated list of items in a library with server-side grouping.
        Returns a mixed array of standalone items (books/videos) and collections.
        Collections (type=2) include their nested items in the `items` field.
        Items are sorted alphabetically; collection items appear grouped after their collection header.
        When pagination splits a collection, the continuation page marks it with `partial: true`.
      operationId: listLibraryItems
      tags:
        - Items
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 20
          description: "Number of items per page (max 20)"
        - name: nextToken
          in: query
          schema:
            type: string
          description: "Pagination token from previous response"
      responses:
        "200":
          description: List of items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetLibrariesContentResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/collections:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: List collections
      description: Get all collections in a library
      operationId: listCollections
      tags:
        - Collections
      responses:
        "200":
          description: List of collections
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetCollectionsResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Create collection
      description: Create a new collection in a library (name must be unique)
      operationId: createCollection
      tags:
        - Collections
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCollectionRequest"
      responses:
        "201":
          description: Collection created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateCollectionResponse"
        "400":
          description: Invalid request or duplicate name
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/collections/{collectionId}:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string
      - name: collectionId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: Get collection
      description: Get a collection by ID
      operationId: getCollection
      tags:
        - Collections
      responses:
        "200":
          description: Collection details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetCollectionResponse"
        "404":
          description: Collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Update collection
      description: Update collection name and description
      operationId: updateCollection
      tags:
        - Collections
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateCollectionRequest"
      responses:
        "200":
          description: Collection updated
        "400":
          description: Invalid request or duplicate name
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete collection
      description: Delete a collection (items are orphaned, not deleted)
      operationId: deleteCollection
      tags:
        - Collections
      responses:
        "200":
          description: Collection deleted
        "404":
          description: Collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/books:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Create book
      description: Add a new book to a library
      operationId: createBook
      tags:
        - Items
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBookRequest"
      responses:
        "200":
          description: Book created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateBookResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/books/{bookId}:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string
      - name: bookId
        in: path
        required: true
        schema:
          type: string

    put:
      summary: Update book
      description: Update book details
      operationId: updateBook
      tags:
        - Items
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBookRequest"
      responses:
        "200":
          description: Book updated
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/videos:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Create video
      description: Add a new video (DVD/Bluray) to a library
      operationId: createVideo
      tags:
        - Items
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVideoRequest"
      responses:
        "200":
          description: Video created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateVideoResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/videos/{videoId}:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string
      - name: videoId
        in: path
        required: true
        schema:
          type: string

    put:
      summary: Update video
      description: Update video details
      operationId: updateVideo
      tags:
        - Items
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateVideoRequest"
      responses:
        "200":
          description: Video updated
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/items/{itemId}:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string
      - name: itemId
        in: path
        required: true
        schema:
          type: string

    delete:
      summary: Delete item
      description: Delete an item from a library
      operationId: deleteItem
      tags:
        - Items
      responses:
        "200":
          description: Item deleted
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/items/{itemId}/events:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string
      - name: itemId
        in: path
        required: true
        schema:
          type: string

    get:
      summary: Get item history
      description: Get paginated lending/return history for an item
      operationId: getItemHistoryEvents
      tags:
        - Item History
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 20
          description: "Number of events per page (max 20)"
        - name: nextToken
          in: query
          schema:
            type: string
          description: "Pagination token from previous response"
      responses:
        "200":
          description: Item history events
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemHistoryEntryListResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Create history event
      description: Record a lend or return event for an item
      operationId: createItemHistoryEvent
      tags:
        - Item History
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ItemHistoryEntryRequest"
      responses:
        "201":
          description: Event created
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete item history
      description: Delete all history events for an item
      operationId: deleteItemHistoryEvents
      tags:
        - Item History
      responses:
        "200":
          description: History deleted
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/share:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Share library
      description: Share a library with another user (read-only access)
      operationId: shareLibrary
      tags:
        - Sharing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShareRequest"
      responses:
        "200":
          description: Library shared
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /libraries/{libraryId}/unshare:
    parameters:
      - name: libraryId
        in: path
        required: true
        schema:
          type: string

    post:
      summary: Unshare library
      description: Remove library sharing from one or more users
      operationId: unshareLibrary
      tags:
        - Sharing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UnshareRequest"
      responses:
        "200":
          description: Library unshared
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /search:
    post:
      summary: Search items
      description: Fuzzy search across all items in user's libraries
      operationId: search
      tags:
        - Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchRequest"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

tags:
  - name: Detection
    description: ISBN detection and book lookup
  - name: Libraries
    description: Library management
  - name: Items
    description: Book and item management
  - name: Collections
    description: Collection management within libraries
  - name: Item History
    description: Lending and return tracking
  - name: Sharing
    description: Library sharing between users
  - name: Search
    description: Full-text search across items
